<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My-Nix-Blog</title>
  </head>

  <body>
    <section class="section">
      <div class="container">
<h1 class="title">NixOS Modules Explained</h1>
<p class="subtitle"><strong>2025-05-05</strong></p>
<h2 id="nixos-modules">NixOS Modules</h2>
<p>TL;DR: In this post I break down the NixOS module system and explain how to define options. I take notes in markdown so it's written in markdown (sorry old reddit). I write about things to deepen understanding, you think you know until you try to explain it to someone. Anyways, I hope this is useful.</p>
<ul>
<li>Most modules are functions that take an attribute set and return an attribute set.</li>
</ul>
<p>Refresher:</p>
<ul>
<li>An attribute set is a collection of name-value pairs wrapped in curly braces:</li>
</ul>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  </span><span style="color:#d08770;">string </span><span>= &quot;</span><span style="color:#a3be8c;">hello</span><span>&quot;;
</span><span>  </span><span style="color:#d08770;">int </span><span>= </span><span style="color:#d08770;">3</span><span>;
</span><span>}
</span></code></pre>
<ul>
<li>A function with an attribute set argument:</li>
</ul>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#8fa1b3;">{ </span><span>a, b </span><span style="color:#8fa1b3;">}</span><span>: </span><span style="color:#bf616a;">a </span><span>+ </span><span style="color:#bf616a;">b
</span></code></pre>
<ul>
<li>The simplest possible NixOS Module:</li>
</ul>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#8fa1b3;">{ </span><span>... </span><span style="color:#8fa1b3;">}</span><span>:
</span><span>{
</span><span style="background-color:#bf616a;color:#2b303b;">}</span><span>
</span></code></pre>
<p>NixOS produces a full system configuration by combining smaller, more isolated and reusable components: <strong>Modules</strong>. In my opinion modules are one of the first things you should understand when learning about NixOS.</p>
<ul>
<li>
<p>A NixOS module defines configuration options and behaviors for system components, allowing users to extend, customize, and compose configurations declaratively.</p>
</li>
<li>
<p>A module is a file containing a Nix expression with a specific structure. It <em>declares</em> options for other modules to define (give a value). Modules were introduced to allow extending NixOS without modifying its source code.</p>
</li>
<li>
<p>To define any values, the module system first has to know which ones are allowed. This is done by declaring options that specify which attributes can be set and used elsewhere.</p>
</li>
<li>
<p>If you want to write your own modules, I recommend setting up <a href="https://github.com/nix-community/nixd?tab=readme-ov-file">nixd</a> or <a href="https://github.com/oxalica/nil">nil</a> with your editor of choice. This will allow your editor to warn you about missing arguments and dependencies as well as syntax errors.</p>
</li>
</ul>
<h3 id="declaring-options">Declaring Options</h3>
<p>The following is <code>nixpkgs/nixos/modules/programs/vim.nix</code>:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  config,
</span><span>  lib,
</span><span>  pkgs,
</span><span>  ...
</span><span style="color:#8fa1b3;">}</span><span>:
</span><span>
</span><span style="color:#b48ead;">let
</span><span>  </span><span style="color:#d08770;">cfg </span><span>= </span><span style="color:#bf616a;">config</span><span>.</span><span style="color:#bf616a;">programs</span><span>.</span><span style="color:#bf616a;">vim</span><span>;
</span><span style="color:#b48ead;">in
</span><span>{
</span><span>  </span><span style="color:#d08770;">options</span><span>.</span><span style="color:#d08770;">programs</span><span>.</span><span style="color:#d08770;">vim </span><span>= {
</span><span>    </span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkEnableOption </span><span>&quot;</span><span style="color:#a3be8c;">Vi IMproved, an advanced text</span><span>&quot;;
</span><span>
</span><span>    </span><span style="color:#d08770;">defaultEditor </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkEnableOption </span><span>&quot;</span><span style="color:#a3be8c;">vim as the default editor</span><span>&quot;;
</span><span>
</span><span>    </span><span style="color:#d08770;">package </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkPackageOption pkgs </span><span>&quot;</span><span style="color:#a3be8c;">vim</span><span>&quot; { </span><span style="color:#d08770;">example </span><span>= &quot;</span><span style="color:#a3be8c;">vim-full</span><span>&quot;; };
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># </span><span style="font-weight:bold;color:#ebcb8b;">TODO</span><span style="color:#65737e;">: convert it into assert after 24.11 release
</span><span>  </span><span style="color:#d08770;">config </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf </span><span>(</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">enable </span><span>|| </span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor</span><span>) {
</span><span>    </span><span style="color:#d08770;">warnings </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf </span><span>(</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor </span><span>&amp;&amp; !</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">enable</span><span>) [
</span><span>      &quot;</span><span style="color:#a3be8c;">programs.vim.defaultEditor will only work if programs.vim.enable is enabled, which will be enforced after the 24.11 release</span><span>&quot;
</span><span>    ];
</span><span>    </span><span style="color:#d08770;">environment </span><span>= {
</span><span>      </span><span style="color:#d08770;">systemPackages </span><span>= [ </span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">package </span><span>];
</span><span>      </span><span style="color:#d08770;">variables</span><span>.</span><span style="color:#d08770;">EDITOR </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor </span><span>(</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkOverride </span><span style="color:#d08770;">900 </span><span>&quot;</span><span style="color:#a3be8c;">vim</span><span>&quot;);
</span><span>      </span><span style="color:#d08770;">pathsToLink </span><span>= [ &quot;</span><span style="color:#a3be8c;">/share/vim-plugins</span><span>&quot; ];
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<ul>
<li>It provides options to enable Vim, set it as the default editor, and specify the Vim package to use.</li>
</ul>
<ol>
<li>Module Inputs and Structure:</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  config,
</span><span>  lib,
</span><span>  pkgs,
</span><span>  ...
</span><span style="color:#8fa1b3;">}
</span></code></pre>
<ul>
<li>
<p>Inputs: The module takes the above inputs and <code>...</code> (catch-all for other args)</p>
<ul>
<li>
<p><code>config</code>: Allows the module to read option values (e.g. <code>config.programs.vim.enable</code>). It provides access to the evaluated configuration.</p>
</li>
<li>
<p><code>lib</code>: The Nixpkgs library, giving us helper functions like <code>mkEnableOption</code>, <code>mkIf</code>, and <code>mkOverride</code>.</p>
</li>
<li>
<p><code>pkgs</code>: The Nixpkgs package set, used to access packages like <code>pkgs.vim</code></p>
</li>
<li>
<p><code>...</code>: Allows the module to accept additional arguments, making it flexible for extension in the future.</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Key Takeaways: A NixOS module is typically a function that can include <code>config</code>, <code>lib</code>, and <code>pkgs</code>, but it doesnâ€™t require them. The <code>...</code> argument ensures flexibility, allowing a module to accept extra inputs without breaking future compatibility. Using <code>lib</code> simplifies handling options (mkEnableOption, mkIf, mkOverride) and helps follow best practices. Modules define options, which users can set in their configuration, and <code>config</code>, which applies changes based on those options.</p>
</blockquote>
<ol start="2">
<li>Local Configuration Reference:</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#b48ead;">let
</span><span>  </span><span style="color:#d08770;">cfg </span><span>= </span><span style="color:#bf616a;">config</span><span>.</span><span style="color:#bf616a;">programs</span><span>.</span><span style="color:#bf616a;">vim</span><span>;
</span><span style="color:#b48ead;">in
</span></code></pre>
<ul>
<li>This is a local alias. Instead of typing <code>config.programs.vim</code> over and over, the module uses <code>cfg</code>.</li>
</ul>
<ol start="3">
<li>Option Declaration</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#bf616a;">options</span><span>.</span><span style="color:#bf616a;">programs</span><span>.</span><span style="color:#bf616a;">vim </span><span style="background-color:#bf616a;color:#2b303b;">=</span><span> {
</span><span>  </span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkEnableOption </span><span>&quot;</span><span style="color:#a3be8c;">Vi IMproved, an advanced text</span><span>&quot;;
</span><span>  </span><span style="color:#d08770;">defaultEditor </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkEnableOption </span><span>&quot;</span><span style="color:#a3be8c;">vim as the default editor</span><span>&quot;;
</span><span>  </span><span style="color:#d08770;">package </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkPackageOption pkgs </span><span>&quot;</span><span style="color:#a3be8c;">vim</span><span>&quot; { </span><span style="color:#d08770;">example </span><span>= &quot;</span><span style="color:#a3be8c;">vim-full</span><span>&quot;; };
</span><span>}</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span>
</span></code></pre>
<p>This defines three user-configurable options:</p>
<ul>
<li>
<p><code>enable</code>: Turns on Vim support system-wide.</p>
</li>
<li>
<p><code>defaultEditor</code>: Sets Vim as the system's default <code>$EDITOR</code>.</p>
</li>
<li>
<p><code>package</code>: lets the user override which Vim package is used.</p>
</li>
</ul>
<blockquote>
<p><code>mkPackageOption</code> is a helper that defines a package-typed option with a default (<code>pkgs.vim</code>) and provides docs + example.</p>
</blockquote>
<ol start="4">
<li>Conditional Configuration</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#bf616a;">config </span><span style="background-color:#bf616a;color:#2b303b;">=</span><span> </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf </span><span>(</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">enable </span><span>|| </span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor</span><span>) {
</span></code></pre>
<ul>
<li>This block is only activated if <em>either</em> <code>programs.vim.enable</code> or <code>defaultEditor</code> is set.</li>
</ul>
<ol start="5">
<li>Warnings</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#bf616a;">warnings </span><span style="background-color:#bf616a;color:#2b303b;">=</span><span> </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf </span><span>(</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor </span><span>&amp;&amp; !</span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">enable</span><span>) [
</span><span>  &quot;</span><span style="color:#a3be8c;">programs.vim.defaultEditor will only work if programs.vim.enable is enabled, which will be enforced after the 24.11 release</span><span>&quot;
</span><span>]</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span>
</span></code></pre>
<ul>
<li>Gives you a soft warning if you try to set <code>defaultEditor = true</code> without also enabling Vim.</li>
</ul>
<ol start="6">
<li>Actual System Config Changes</li>
</ol>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#bf616a;">environment </span><span style="background-color:#bf616a;color:#2b303b;">=</span><span> {
</span><span>  </span><span style="color:#d08770;">systemPackages </span><span>= [ </span><span style="color:#bf616a;">cfg</span><span>.</span><span style="color:#bf616a;">package </span><span>];
</span><span>  </span><span style="color:#d08770;">variables</span><span>.</span><span style="color:#d08770;">EDITOR </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf cfg</span><span>.</span><span style="color:#bf616a;">defaultEditor </span><span>(</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkOverride </span><span style="color:#d08770;">900 </span><span>&quot;</span><span style="color:#a3be8c;">vim</span><span>&quot;);
</span><span>  </span><span style="color:#d08770;">pathsToLink </span><span>= [ &quot;</span><span style="color:#a3be8c;">/share/vim-plugins</span><span>&quot; ];
</span><span>}</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span>
</span></code></pre>
<ul>
<li>It adds Vim to your <code>systemPackages</code>, sets <code>$EDITOR</code> if <code>defaultEditor</code> is true, and makes <code>/share/vim-plugins</code> available in the environment.</li>
</ul>
<p>The following is a bat home-manager module that I wrote:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#65737e;"># bat.nix
</span><span>{
</span><span>  pkgs,
</span><span>  config,
</span><span>  lib,
</span><span>  ...
</span><span style="color:#8fa1b3;">}</span><span>: </span><span style="color:#b48ead;">let
</span><span>  </span><span style="color:#d08770;">cfg </span><span>= </span><span style="color:#bf616a;">config</span><span>.</span><span style="color:#bf616a;">custom</span><span>.</span><span style="color:#bf616a;">batModule</span><span>;
</span><span style="color:#b48ead;">in </span><span>{
</span><span>  </span><span style="color:#d08770;">options</span><span>.</span><span style="color:#d08770;">custom</span><span>.</span><span style="color:#d08770;">batModule</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkOption </span><span>{
</span><span>    </span><span style="color:#d08770;">type </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">types</span><span>.</span><span style="color:#bf616a;">bool</span><span>;
</span><span>    </span><span style="color:#d08770;">default </span><span>= </span><span style="color:#d08770;">false</span><span>;
</span><span>    </span><span style="color:#d08770;">description </span><span>= &quot;</span><span style="color:#a3be8c;">Enable bat module</span><span>&quot;;
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#d08770;">config </span><span>= </span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">mkIf cfg</span><span>.</span><span style="color:#bf616a;">enable </span><span>{
</span><span>    </span><span style="color:#d08770;">programs</span><span>.</span><span style="color:#d08770;">bat </span><span>= {
</span><span>      </span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>      </span><span style="color:#d08770;">themes </span><span>= {
</span><span>        </span><span style="color:#d08770;">dracula </span><span>= {
</span><span>          </span><span style="color:#d08770;">src </span><span>= </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">fetchFromGitHub </span><span>{
</span><span>            </span><span style="color:#d08770;">owner </span><span>= &quot;</span><span style="color:#a3be8c;">dracula</span><span>&quot;;
</span><span>            </span><span style="color:#d08770;">repo </span><span>= &quot;</span><span style="color:#a3be8c;">sublime</span><span>&quot;; </span><span style="color:#65737e;"># Bat uses sublime syntax for its themes
</span><span>            </span><span style="color:#d08770;">rev </span><span>= &quot;</span><span style="color:#a3be8c;">26c57ec282abcaa76e57e055f38432bd827ac34e</span><span>&quot;;
</span><span>            </span><span style="color:#d08770;">sha256 </span><span>= &quot;</span><span style="color:#a3be8c;">019hfl4zbn4vm4154hh3bwk6hm7bdxbr1hdww83nabxwjn99ndhv</span><span>&quot;;
</span><span>          };
</span><span>          </span><span style="color:#d08770;">file </span><span>= &quot;</span><span style="color:#a3be8c;">Dracula.tmTheme</span><span>&quot;;
</span><span>        };
</span><span>      };
</span><span>      </span><span style="color:#d08770;">extraPackages </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">bat-extras</span><span>; [
</span><span>        </span><span style="color:#bf616a;">batdiff
</span><span>        </span><span style="color:#bf616a;">batman
</span><span>        </span><span style="color:#bf616a;">prettybat
</span><span>        </span><span style="color:#bf616a;">batgrep
</span><span>      ];
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<p>Now I could add this to my <code>home.nix</code> to enable it:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#65737e;"># home.nix
</span><span style="color:#bf616a;">custom </span><span style="background-color:#bf616a;color:#2b303b;">=</span><span> {
</span><span>  </span><span style="color:#d08770;">batModule</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>}
</span></code></pre>
<ul>
<li>
<p>If I set this option to true the bat configuration is dropped in place. If it's not set to true, it won't put the bat configuration in the system. Same as with options defined in modules within the Nixpkgs repository.</p>
</li>
<li>
<p>If I had set the default to <code>true</code>, it would automatically enable the module without requiring an explicit <code>custom.batModule.enable = true;</code> call in my <code>home.nix</code>.</p>
</li>
</ul>
<h3 id="module-composition">Module Composition</h3>
<ul>
<li>
<p>NixOS achieves its full system configuration by combining the configurations defined in various modules. This composition is primarily handled through the <code>imports</code> mechanism.</p>
</li>
<li>
<p><code>imports</code>: This is a standard option within a NixOS or Home Manager configuration (often found in your configuration.nix or home.nix). It takes a list of paths to other Nix modules. When you include a module in the imports list, the options and configurations defined in that module become part of your overall system configuration.</p>
</li>
<li>
<p>You declaratively state the desired state of your system by setting options across various modules. The NixOS build system then evaluates and merges these option settings. The culmination of this process, which includes building the entire system closure, is represented by the derivation built by <code>config.system.build.toplevel</code>.</p>
</li>
</ul>
<h4 id="resources-on-modules">Resources on Modules</h4>
<ul>
<li>
<p><a href="https://xeiaso.net/talks/asg-2023-nixos/">xeiaso Nixos Modules for fun &amp; profit</a></p>
</li>
<li>
<p><a href="https://nixos.wiki/wiki/NixOS_modules">NixOS Wiki NixOS modules</a></p>
</li>
<li>
<p><a href="https://nix.dev/tutorials/module-system/index.html">nix.dev Module System</a></p>
</li>
<li>
<p><a href="https://nix.dev/tutorials/module-system/a-basic-module/index.html">nix.dev A basic module</a></p>
</li>
<li>
<p><a href="https://nixos-and-flakes.thiscute.world/other-usage-of-flakes/module-system">NixOS Flakes Book Module System</a></p>
</li>
</ul>
 </div>
    </section>
  </body>
</html>
